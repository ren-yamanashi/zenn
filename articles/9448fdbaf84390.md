---
title: "IPv6 対応における IPv4 と IPv6 の共存・変換技術"
published: true
cssclass: zenn
emoji: "🌐"
type: "tech"
topics: ["ネットワーク", "ip", "ipv4", "ipv6"]
url: "https://zenn.dev/yamaren/articles/9448fdbaf84390"
---

こんにちは。現在 IPv6 について勉強中の山梨です。

私はネットワークについての知識が浅く、IPv6 については「IPv4 よりアドレスが長い IP アドレス」くらいの認識でした。
そんな中、ラムダノート社から出版されているプロフェッショナル IPv6 という本を知り、この機に IPv6 について学んでみようと思い書籍を購入しました。

今回は、その本を読んだ内容をもとに、IPv6 対応における IPv4 と IPv6 の共存・変換技術についてまとめます。

https://www.lambdanote.com/products/ipv6-2

## 1. 用語の定義

- ノード
  - ネットワークを図示したとき、何らかの接点となる存在
  - ネットワークの末端に接続された機器、ネットワークの中心に接続されつつパケットを転送する機器、ルーターなど
- ホスト
  - パケットを転送する機能を持たずネットワークの末端に接続されたノード(エンドノード)
- サイト
  - 特定の管理または技術的な境界内での IPv6 アドレスのグループを指す
- リンク
  - ノードをリンク層、すなわち IP の直下のレイヤで通信できる通信機能または媒体(イーサネットなど)
- NAT(Network Address Translation)
  - パケットが持つ IP アドレスを別の IP アドレスに変換する仕組み(またはその仕組みを搭載した機器)

## 2. IPv6 概要

### 2.1. IPv6 開発の背景

IPv6 とは、IP (インターネットプロトコル) のバージョン 6 です。
この IPv6 が開発された背景には IPv4 (インターネットプロトコルのバージョン 4) アドレス在庫枯渇問題があります。
IPv4 では IP アドレスとして長さが 32 ビットの値を扱うことになっているので、表現可能な値の数は 2 の 32 通り (約 43 億通り) となります。しかし、インターネットの普及により、43 億個ではアドレスの在庫が枯渇することが予想されました。その問題を解決するために開発されたのが、IPv6 です。

IPv6 ではアドレスを 128 ビットで表現するので、表現可能な値の数は 2 の 128 通り (約 340 澗{かん}) という、1 兆の 1 兆倍の 1 兆倍よりもさらに大きい個数の IP アドレスを割り当てることができます。

### 2.2. IPv6 のアドレス構成

IPv4 は 32 ビットで構成され、前半部分を**ネットワーク部**、後半部分を**ホスト部**と呼びます。
一方 IPv6 のアドレスは 128 ビットで構成され、そのうち前半部分を**サブネットプレフィックス**、後半部分を**インターフェイス識別子**と呼び、前半部分が同じであれば (サブネットプレフィックスが同じであれば)「同じネットワーク」と考えることができます。

![IPv6-IPv4-Address](https://storage.googleapis.com/zenn-user-upload/4b68a4cea0c1-20240602.png)

IPv4 と IPv6 のアドレスの構成要素の違いは、一見名称だけのように思えますが、大きく異なる点があります。

[RFC1122](https://datatracker.ietf.org/doc/html/rfc1122) では、IPv4 ではアドレスの構成要素を ”Network-number”, “Host-number” としており、これは IPv4 アドレスが「ホスト」そのものを示すことを表しています。

一方、IPv6 ではアドレスの構成要素を ”subnet prefix”, ”Interface Identifiers” としており、これはインターフェイスを識別することを表しています。
この名称からは IPv6 アドレスはあくまでもネットワークインターフェイスを識別するものであり、必ずしも機器を識別するものではないという前提が感じられます。

## 3. IPv6対応

IPv6 は IPv4 と同じネットワーク層のプロトコルであり、ネットワークを超えてパケットを配送するという点では、インターネットにおいて IPv4 と同じ機能を担うプロトコルです。
しかし、IPv6 と IPv4 の違いはアドレスの長さだけではなく、加えて IPv6 と IPv4 の直接的な互換性はありません。

また、現時点のインターネットでは既存の IPv4 が使われ続けているため、IPv6 のみのネットワーク運用について考えるのではなく、同じインターネット上で IPv4 と IPv6 を並行して利用する運用を考慮する必要がありそうです。

つまり、**IPv6 への移行**ではなく、**IPv6 への対応**が求められると考えられます。

- IPv6 への移行：IPv4 を捨てて IPv6 に完全に移ること
- IPv6 への対応：IPv4 を利用するユーザーが多い状況で、それまで対応していなかった IPv6 という新しいプロトコルに対応すること

## 4. IPv4 と IPv6 の共存技術

以降では、IPv6 の対応の際に用いられる技術として、以下の 3 点について取り上げます

- IPv6 と IPv4 のデュアルスタック
- IPv6 ネットワーク同士を繋ぐ IPv4 トンネル
- IPv4 ネットワーク同士を繋ぐ IPv6 トンネル

ただし、これらはあくまでもネットワークを IPv6 で対応させる技術であり、「IPv6 に対応する」とはネットワークだけでなく、ユーザー、サーバー、アプリケーションの対応が必要であることに注意が必要です

### 4.1. IPv6 と IPv4 のデュアルスタック

ある特定のプロトコルを扱うためのソフトウェアの実装を**プロトコルスタック**と呼びます。IPv4 と IPv6 は異なるプロトコルなので、プロトコルスタックとしても別です。
そして、全く別々の 2 つのプロトコルスタックを使える状態を**デュアルスタック**と呼びます。

つまり IPv6 と IPv4 のデュアルスタックとは、IP (インターネットプロトコル) を扱う単一機器に IPv4 と IPv6 という仕様の異なるプロトコルスタックを共存させることです。
この技術により、単一の機器において IPv4 と IPv6 を同時に動作させることができます。IPv4 対応機器と通信を行う際には IPv4 を使用し、IPv6 対応機器と通信を行う際には IPv6 を使用することになります。

**4.1.1 DNS の役割**
現在のインターネットでは、ネットワーク層が IPv4 と IPv6 のデュアルスタックになった場合でも、ネットワークを利用する側の視点では「インターネットは 1 つ」という状態を仮想的に実現するために、DNS を利用しています。

DNS ではドメイン名から IP アドレスを解決するために、レコードと呼ばれる仕組みを利用しています。レコードには IPv4 アドレス用と IPv6 アドレス用とを別々に設定できます。
:::message
IPv4 アドレス用は A レコード、IPv6 アドレス用は AAAA (クアッド・エー) レコードと呼びます
(IPv6 のビット数は IPv4 の 4 倍なので AAAA)
:::

例えば、`www.example.com` という 1 つのドメインに対し、IPv4 と IPv6 の両方の IP アドレスを登録できるようになっています。

この時、以下の画像のように IPv4 だけを利用する場合には IPv4 アドレスに対する名前解決が行われ、IPv6 だけを利用する場合には IPv6 アドレスだけの名前解決が行われます。(1 枚目)
また IPv4 と IPv6 の両方の利用を試みる場合には両方のアドレスに対する名前解決が行われます。(2 枚目)

![dual-stack-packet](https://storage.googleapis.com/zenn-user-upload/3cf31bbc5bf7-20240602.png)
![dual-stack-packet-2](https://storage.googleapis.com/zenn-user-upload/7e1547d8a5b0-20240602.png)

::: message
サーバーでデュアルスタックを実現するためには、ネットワークインターフェースに IPv4 アドレス、IPv6 アドレスの両方を割り当てる必要があります。
:::

また、注意したい点として、ここで IPv4 と IPv6 のどちらを使って通信するのかを判断する DNS ではなくユーザー側になります。

例として、IPv4 と IPv6 の両方で運用されている Web サーバーで考えてみます。
ユーザーが Web ブラウザでサーバーに接続するためには、まず DNS で `www.example.com` の名前解決を試みる必要があります。その際には、IPv4 の A レコードと、IPv6 の AAAA レコードの両方に対して名前解決を試みます。

もし両方ともに結果が返ってきた場合、IPv4 で接続するのか、それとも IPv6 で接続するのかを判断するのは、Web ブラウザです。

このように、接続に IPv4 を使うのか、それとも IPv6 を使うのかを判断するのは、個々のアプリケーションの仕事であり、他の環境が全て同じであったとしても、IPv4 と IPv6 のどちらを使うべきかは、アプリケーションごとに異なる可能性もあります。

その為 IPv4 と IPv6 のどちらを使うのか判断するコードを、アプリケーションごとに書く必要があります。

### 4.2. IPv6 ネットワーク同士を繋ぐ IPv4 トンネル

IPv6 に対応するための方法として、IPv6 ネットワーク同士を繋ぐ IPv4 トンネル技術があります。IPv4 ネットワーク上で IPv6 パケットをルーティングする技術です。

このトンネリング技術は主に以下の方法で使用できます

- ルーター間
- ホストからルーター
- ホスト間
- ルーターからホスト

この記事では、IPv4 トンネルを経由して IPv6 インターネットへと接続する技術として **6to4**を取り上げます。

**4.2.1. 6to4**
6to4 は、ルーター間のトンネリング技術で、グローバル IPv4 アドレスを 1 つ以上持つサイトに対し、ユニークな IPv6 アドレスプレフィックスを割り当て、IPv4 ネットワークを通じてカプセル化した IPv6 パケットを転送する技術です。(IPv6 パケットを IPv4 パケットにカプセル化)

グローバル IPv4 アドレスに対して割り当てられる 6to4 プリフィクスは、[RFC3056](https://datatracker.ietf.org/doc/html/rfc3056) で以下のように決められており、このアドレスプレフィックスを用いて、各サイトのノードへ 6to4 アドレス (6to4 プレフィックスを使用して構築された IPv6 アドレス) を割り当てることができます

- 6to4 アドレスプレフィックス：6to4 で使用されるプレフィックス (`2002:V4ADDR::/48`)  
`V4ADDR`：有効でグローバルに一意の 32 ビット IPv4 アドレス

**4.2.2. 6to4による通信**
(以下、用語の定義です)([RFC3056](https://datatracker.ietf.org/doc/html/rfc3056) を参照)

- 6to4 ルーター  
  - 6to4 疑似インターフェースをサポートする IPv6 ルーター  
  - 通常、IPv6 サイトと広域 IPv4 ネットワーク間の境界ルーター
- 6to4 ホスト  
  - 少なくとも 1 つの 6to4 アドレスを持つ IPv6 ホスト

(以下、https://www.nic.ad.jp/ja/newsletter/No37/0800.html より引用)
> 6to4 ホストと、6to4 ルーターによって以下のような通信を行うことができます
>

![6to4-router](https://www.nic.ad.jp/ja/newsletter/No37/images/0800_2.gif)
*https://www.nic.ad.jp/ja/newsletter/No37/0800.html 図2 6to4 の通信より引用*

1. 同じ 6to4 アドレスプレフィックスを持つホスト同士の通信(ホスト A - ホスト B 間)

    > 通信先ホストのアドレスプリフィクスが、自身の持つ 6to4 プリフィクスと同じ場合、6to4 ルータは特別な処理を行わず、通常のサイト内 IPv6 ネットワークを介して IPv6 パケットがルーティングされます。（図2 ホスト A － ホスト B 間）
    >
2. 別の 6to4 アドレスプレフィックスを持つホスト同士の通信 (ホスト A - ホスト C 間)

    > ある 6to4 ホストが、別のサイトにある 6to4 ホストと通信する場合は、6to4 ルータが、IPv6 パケットを IPv4 インターネットを通じて、目的とするサイトの 6to4 ルータへ転送します。この時、6to4 ルータは、IPv6 パケットを IPv4 パケットにカプセル化して、相手先の 6to4 ルータへ送信します。
    カプセル化の時に用いられる送信先 IPv4 アドレスは、IPv6 パケットにある 6to4 アドレスプリフィクスから取り出されます。相手先 6to4 ルータは、受け取った IPv4 パケットのカプセル化を解除し、元の IPv6 パケットを取り出します。
    取り出した IPv6 パケットは、通常のサイト内 IPv6 ネットワークを介して、相手先 6to4 ホストにルーティングされます。（図 2 ホスト A－ホスト C 間）
    >
3. IPv6 インターネット上のネイティブな IPv6 ホストとの通信(ホスト A - ホスト D 間)

    > 6to4 ホストが IPv6 インターネットのホストと通信する場合、6to4 ルータが IPv6 パケットをカプセル化しますが、上記（2）とは異なり、パケットは IPv4 インターネットと IPv6 インターネットの両方に接続されている 6to4 リレールータに対して送信されます。 6to4 リレールータは、受け取った IPv4 パケットのカプセル化を解除し元の IPv6 パケットを取り出した後、IPv6 インターネットにある目的の IPv6 ホストへ送信します。（図2 ホスト A － ホスト D 間）

### 4.3. IPv4 ネットワーク同士を繋ぐ IPv6 トンネル

IPv6 インターネットへと接続する環境が整っていくと、IPv4 と IPv6 を同時に運用する時にコストを削減する方法をどのように実現するのかという議論が活発になりました。その代表的なものとして挙げられるのが、**DS-Lite** (**Dual Stack Lite**)です。

**4.3.1. DS-Lite**
DS-Lite は、基幹ネットワークを IPv6 のみで構成しつつ、IPv4 のための IPv6 トンネルを使うことで、ユーザーに対して IPv4 と IPv6 の両方を提供できるというもので、その内容は [RFC6333](https://datatracker.ietf.org/doc/html/rfc6333) に規定されています。

DS-Lite では以下の画像のように基幹ネットワークを IPv6 のみで構成し、家庭内などの利用者の環境には DS-Lite 対応 CPE (Customer Premises Equipment) を設置します。
そして、家庭内などではグローバル IPv6 アドレスとプライベート IPv4 アドレスを利用します。

(CPE とは、ユーザーの敷地内に設置される、ルーターなどの通信機器です)

![IPv6-tunnel](https://storage.googleapis.com/zenn-user-upload/f3e53042e3b5-20240602.png)

DS-Lite を使用して IPv6 ネットワークのホストと通信するケース、IPv4 ネットワークのホストと通信するケースはそれぞれ以下のようになります

- **IPv6 ネットワークのホストと通信するケース**
CPE は IPv6 パケットをそのまま基幹ネットワークへと転送します。

- **IPv4 ネットワークのホストと通信するケース**
以下のような手順でパケットが転送されます。
  1. IPv4 パケットは CPE によって IPv6 パケットにカプセル化される
  2. IPv6 パケットは、基幹ネットワークに設置された AFTR (Address Family Transition Router) と呼ばれる機器まで転送される
  3. AFTR は、CPE によってカプセル化された IPv4 パケットを IPv6 パケットから取り出した上で NAT による IP アドレスの変換を行い、IPv4 インターネットへとパケットを転送します。

DS-Lite の利点としては、基幹ネットワークをシングルスタックで運用できることから、デュアルスタック運用と比較して、コストを削減できるという点が挙げられます。

## 5. IPv4 / IPv6 変換技術

IPv6 から IPv4 へと変換したり、IPv4 から IPv6 へと変換したりする変換技術は、トンネル技術とは異なり、各ユーザー環境をデュアルスタックにせずに IPv4 と IPv6 両方のインターネットを利用可能とします。

例えば、エンドユーザーが、「IPv4 インターネットと通信しているつもり」で IPv6 インターネット上の相手と通信できる仕組みや、逆に IPv6 から IPv4 への通信する仕組みがあります。

### 5.1. IPv4 / IPv6 変換の枠組み

現在では IPv6 の利用が増えてはいるものの、インターネットの大部分は IPv4 で構成されているため、IPv6 のみで構成されているシングルスタックネットワークにおいて、何らかの手段で IPv4 の機器との通信が要求される場合があります。

しかし、IPv4 と IPv6 には直接的な互換性がないので、IPv6 シングルスタックネットワークで IPv4 の機器と通信を行うためには、IPv6 による通信を IPv4 の通信へと変換する仕組みが必要です。

以降では、IPv4/IPv6 変換を実現するための仕組みとして、以下の 2 つについて記述します。

- NAT64
  - IPv4 / IPv6 変換を実現するための具体的な仕組み ([RFC6146](https://datatracker.ietf.org/doc/html/rfc6146) で規定)  
  - プライベート IPv4 アドレスとグローバル IPv4 アドレスを変換する通常の NAT (NAT44) に対し、IPv6 アドレスと IPv4 アドレスを変換する為、ステートの保持が要求される

- DNS64
  - DNS を利用した名前解決における IPv4/IPv6 変換で、IPv4 のための A レコードを IPv6 の AAAA レコードへと変換する仕組み ([RFC6147](https://datatracker.ietf.org/doc/html/rfc6147) で規定)

### 5.2. NAT64 と DNS64

NAT64 は、主に以下の変換や書き換えを行います

- IPv6 ヘッダ → IPv4 ヘッダの変換
- IPv4 ヘッダ → IPv6 ヘッダの変換
- IPv4 ICMP パケット → ICMPv6 の変換
- 必要に応じて TCP・UDP ヘッダの書き換え

DNS64 は、主に以下の変換を行います

- IPv4 のみで運用されている「名前」を IPv6 で通信できるように変換する

NAT64 と DNS64 は異なる技術ですが、一般的には組み合わせて使われます。
NAT64 と DNS64 を使うと、エンドユーザー向けのネットワークを IPv6 のシングルスタックにしつつ、IPv4 インターネットで提供されているコンテンツの閲覧などが行えるようになります。

![nat64-dns64](https://storage.googleapis.com/zenn-user-upload/858933b8bf36-20240602.png)

例えば、スマホに対して提供されているネットワークが NAT64 + DNS64 を利用して運用されている場合、そのスマホを利用するユーザーは IPv6 しか使わなくなりますが、IPv4 インターネットに接続された Web サーバーからコンテンツを取得できるようになります。

**5.2.1. NAT64**

RFC6146 で定義されている NAT64 の主な想定環境は、「IPv6 ネットワークに接続されたユーザーから開始される通信が NAT64 デバイスによって変換され、IPv4 ネットワークに接続された機器と通信を行う」というものです。

その際に IPv6 アドレスと IPv4 アドレスの変換が行われますが、IPv4 アドレスが貴重な資源なので、複数の IPv6 アドレスが 1 つの IPv4 アドレスを共有しながら利用されることが想定されています。

そのため、NAT64 では IP アドレス情報だけでの変換は行わず、TCP と UDP のポート番号を同時に利用したマッピングが主な利用方法になると思われ、この場合「IPv6 アドレスと TCP/UDP ポート番号」と「IPv4 アドレスと TCP/UDP ポート番号」のバインディング情報が NAT64 機器によって保持されることになります。

**5.2.2. DNS64**

しかし、通信相手である IPv4 インターネットの機器の名前に A レコードだけしか存在しなければ、そもそも IPv6 通信を開始できないので、NAT64 だけではユーザー側の環境を変換することなく IPv6 のみで IPv4 インターネットの機器と通信できるようにはなりません。

IPv6 対応済みのユーザー環境では、通常は通信相手の名前を解決する作業が行われ、その結果に応じて「IPv4 と IPv6 のどちらで通信を行うのか」をアプリケーションが判断します。

例えば、`http://192.0.2.23` のように IPv4 アドレスがそのまま埋め込まれている URL でブラウザからアクセスしようとすると、IPv4 アドレスが得られてしまいます。
これでは IPv6 のみで運用されているネットワークからは通信を開始できないので、NAT64 を経由して IPv4 インターネットと通信を行うこともできません。

実際に起こりうる通信の例をもとに考えて理解を深めていきます

![nat64-dns64-example](https://storage.googleapis.com/zenn-user-upload/539da99fb657-20240602.png)

上記の画像では、ユーザーが IPv6 のみで運用される IPv6 ネットワークに接続しており、キャッシュ DNS サーバーとして DNS64 機器を設定しています。
`www.example.com` は IPv4 アドレス `192.0.2.23` のみで運用されているので、IPv6 での通信は行えません。そのため、NAT64 の環境で IPv6 のみを利用するユーザーが、IPv4 インターネットに接続された機器と通信を行うには、DNS64 を経由する必要があります。

DNS64 機器では、ユーザーからのリクエストに応じて名前解決を行う際、IPv6 アドレスを示す AAAA レコードがある場合にはそのまま結果を返し、IPv4 アドレスを示す A レコードしか存在しない場合には [RFC6052](https://datatracker.ietf.org/doc/html/rfc6052) で定義されている方法で「IPv4 アドレスが埋め込まれた IPv6 アドレス」を返します。

ユーザーが `www.example.com` の名前解決を行なった時に NAT64 ルーターを経由する IPv6 アドレスを DNS64 サーバーが返すことで、IPv4 のみで運用されたサーバーと IPv6 ネットワークにあるユーザーの通信を実現するために、ユーザーのトラフィックが NAT64 ルーターへと誘導されます。

NAT64 ルーターから送信された IPv4 パケットは、`www.example.com` の名前を持つサーバーへと送信され、そのサーバーからの返信は NAT64 ルーターへと送信されます。
IPv4 パケットを受け取った NAT64 ルーターは IPv4 パケットを IPv6 パケットへと変換し、ユーザーへと届けます。

このようにして、NAT64 を経由することで、IPv4 のみで運用されている Web サイトを IPv6 環境でブラウズできるようになります

### 5.3. NAT64 + DNS64 を利用した IPv6 シングルスタック運用

NAT64 + DNS64 の特長は、IPv6 のシングルスタックネットワーク環境から IPv4 インターネットへの通信を可能にしつつ、IPv6 インターネットとの間ではそのまま IPv6 インターネットで通信可能になることです。

IPv4 と IPv6 のデュアルスタック環境では、IPv6 での接続をアプリケーションが試みて失敗し、IPv4 での接続を試みるというフォールバックが発生することがありますが、NAT64 + DNS64 で端末を IPv6 シングルスタックにすると、IPv6 から IPv4 へのフォールバックが発生しないというメリットがあります。

一方で、IPv4 アドレスが直接記述されているなどの理由で DNS が利用されない場合は、DNS64 による変換が行われず、Web ページの一部が見られなくなる可能性があるなどの問題もあります。

[RFC6586](https://datatracker.ietf.org/doc/html/rfc6586) では、それまで IPv4 と IPv6 のデュアルスタックで運用されていたネットワークを、IPv6 シングルスタックへと変更し、少ないユーザーをその環境に移動させた事例が要約されています。

## 6. まとめ

この記事を書くにあたり、IPv6 対応にはどのような技術があるのかを知ることができました。
今度は実践として、AWS などを使用した IPv6 対応を行っていきたいと思います。
(その際にはまた記事に書こうかなと思います)

## 参考文献

この記事は[プロフェッショナル IPv6 第二版](https://www.lambdanote.com/products/ipv6-2)を参考にしています。
著者：小川晃通　氏

https://www.lambdanote.com/products/ipv6-2
https://forest.watch.impress.co.jp/library/software/proipv6/

https://datatracker.ietf.org/doc/html/rfc1122
https://datatracker.ietf.org/doc/html/rfc3056
https://datatracker.ietf.org/doc/html/rfc6052
https://datatracker.ietf.org/doc/html/rfc6146
https://datatracker.ietf.org/doc/html/rfc6147
https://datatracker.ietf.org/doc/html/rfc6333
https://datatracker.ietf.org/doc/html/rfc6586

https://www.nic.ad.jp/ja/newsletter/No37/0800.html
https://www.nic.ad.jp/ja/copyright.html

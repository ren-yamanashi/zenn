---
title: "AWS CDK ã§ ECS (Fargate) + RDS ã‚’ãƒãƒ«ãƒ AZ ã§ä½œæˆ"
published: true
cssclass: zenn
emoji: "ğŸ’¡"
type: "tech"
topics: ["AWS", "ECS", "Fargate", "RDS", "CDK"]
url: "https://zenn.dev/ren_yamanashi/articles/a5b571debb0550"
---

## 1. è¨˜äº‹ã®æ¦‚è¦

ã“ã®è¨˜äº‹ã§ã¯ã€AWS åˆå¿ƒè€…ã®ç§ãŒ CDK ã‚’è§¦ã£ã¦ã¿ã¦ã€ã©ã†ã„ã†ãµã†ã«ãƒªã‚½ãƒ¼ã‚¹ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹æˆã‚’è€ƒãˆãªãŒã‚‰ ECS (Fargate) + RDS ã‚’æ§‹ç¯‰ã—ãŸã‹ã‚’è¨˜ã—ã¾ã™ã€‚

### 1.1. ç›®æ¨™

æœ¬è¨˜äº‹ã®ä¸»ãªç›®æ¨™ã¯ã€AWS CDK ã‚’ä½¿ç”¨ã—ã¦ ECS (Fargate) ã¨ RDS ã®åŸºæœ¬çš„ãªæ§‹æˆã‚’ç†è§£ã—ã€å®Ÿéš›ã«æ§‹ç¯‰ã™ã‚‹æŠ€è¡“ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚  
ä»¥ä¸‹ã«ç¤ºã™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®ç’°å¢ƒã‚’å®Ÿéš›ã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã€IaC ã®åŸºç¤ã¨é–‹ç™ºã®æµã‚Œã‚’ä½“é¨“ã—ã€CDK é–‹ç™ºã¸ã®ä¸€æ­©ã‚’è¸ã¿å‡ºã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

### 1.2. æ§‹æˆå›³

ä»Šå›æ§‹ç¯‰ã™ã‚‹ç’°å¢ƒã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
![aws-architecture-diagram.png](https://storage.googleapis.com/zenn-user-upload/cd2474a087ba-20250111.png)

ECS ã¯ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã•ã›ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ ALB ã‚’é€šã—ã¦è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ECR / CloudWatch / S3 / Secrets Manager ã¨ã®æ¥ç¶šã¯ NAT Gateway ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚  
VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠã—ãŸç†ç”±ã¨ã—ã¦ã¯ã€NAT Gateway ã¯ VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚ˆã‚Šã‚‚æ–™é‡‘ãŒé«˜ã„ã“ã¨ã¨ã€ä»Šå›å®Ÿç¾ã—ãŸã„ã€ŒECS ã¨ ECR / CloudWatch / S3 / Secrets Manager ã®æ¥ç¶šã€ã¨ã„ã†é¢ã§ã¯ VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ©Ÿèƒ½ã¨ã—ã¦ååˆ†ãªãŸã‚ã§ã™ã€‚

### 1.3. æ‰‹é †

ä¸Šè¨˜ã®æ§‹æˆå›³ã‚’ã€ä»¥ä¸‹ã®æ‰‹é †ã§æ§‹ç¯‰ã—ã¦ã„ãã¾ã™

1. ECR ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
2. VPC ã‚’ä½œæˆ
3. ALB ã‚’ä½œæˆ
4. RDS ã‚’ä½œæˆ
5. ECS ã‚’ä½œæˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚„ Dockerfile ã®å†…å®¹ã«ã¤ã„ã¦ã¯ã€ã“ã®è¨˜äº‹ã®æœ¬è³ªã¨ã‚ºãƒ¬ã‚‹ãŸã‚è¨˜è¿°ã‚’çœã„ã¦ã„ã¾ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã® GitHub ãƒªãƒ³ã‚¯ã«è¨˜è¼‰ã—ã¦ãŠã‚Šã¾ã™ï¼

:::details ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
https://github.com/ren-yamanashi/ecs-fargate-cdk/blob/main/src/index.ts
:::

:::details Dockerfile
https://github.com/ren-yamanashi/ecs-fargate-cdk/blob/main/Dockerfile
::

## 2. å®Ÿè£…

:::message
ã“ã®è¨˜äº‹ã§ã¯å‰æã¨ã—ã¦ã€TypeScript, CDK, AWS CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯æ¸ˆã‚“ã§ã„ã‚‹ã‚‚ã®ã¨ã—ã¦è¨˜è¿°ã—ã¦ãŠã‚Šã¾ã™ã€‚
:::

### 2.1. å…¨ä½“åƒã®å…±æœ‰

å…·ä½“çš„ãªå®Ÿè£…ã«å…¥ã‚‹å‰ã«ã€ä»Šå›ã®å…¨ä½“çš„ãªæ–¹é‡ã‚’è€ƒãˆã¾ã™ã€‚
ä»Šå›ã¯ã€AWS ãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã« Construct ã‚’ä½œæˆã—ã¦ã€Stack ã§ãã® Construct ã‚’é€£æºã•ã›ã‚‹æ–¹é‡ã§è€ƒãˆã¦ã„ã¾ã™ã€‚  
ãã“ã¾ã§å¤§ããªæ§‹æˆã§ã¯ãªã„ãŸã‚ã€å…¨ã¦ã® Construct ã‚’ã‚¯ãƒ©ã‚¹åˆ†ã‘ã›ãšã« Stack ã«æ›¸ãã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€å¯èª­æ€§ã®å‘ä¸Šã¨ãƒªã‚½ãƒ¼ã‚¹é–“ã®ç¹‹ãŒã‚Šã‚’æ˜ç¢ºåŒ–ã™ã‚‹ç›®çš„ã§ã“ã®ã‚ˆã†ãªæ–¹é‡ã‚’é¸æŠã—ã¾ã—ãŸã€‚  
æœ€çµ‚çš„ã«ã¯ã€ä»¥ä¸‹ã®æ„Ÿã˜ã§ Stack ã‚’é€šã˜ã¦ Construct é–“ã®ã‚„ã‚Šå–ã‚Šã‚’å®Ÿç¾ã•ã›ãŸã„ã§ã™

```ts
export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // ECR
    const ecr = new Ecr(/** some properties */);

    // VPC
    const vpc = new Vpc(/** some properties */);

    // ALB
    const alb = new Alb(/** some properties */);

    // RDS
    const rds = new Rds(/** some properties */);

    // ECS (Fargate)
    const ecs = new Ecs(/** some properties */);
  }
}
```

ã¾ãŸã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è€ƒãˆã¦ã„ã¾ã™

```bash
./lib/
â”œâ”€â”€ constructs
â”‚   â”œâ”€â”€ alb.ts
â”‚   â”œâ”€â”€ ecs.ts
â”‚   â”œâ”€â”€ ...etc
â””â”€â”€ sample-node-app-stack.ts
```

### 2.2. ECR ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ

ã¾ãšã¯ã€ECR ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

#### 2.2.1. ECR ç”¨ã® Construct ã‚’å®šç¾©

ECR ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆã«ã¯ã€CDK ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å«ã¾ã‚Œã‚‹ L2 ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã®ä»–ã« cdk-ecr-deployment ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/cdklabs/cdk-ecr-deployment

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€CDK ã§æ§‹æˆã™ã‚‹ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä»»æ„ã®ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™

```ts:lib/construct/ecr.ts
import path from "node:path";

import { IgnoreMode, RemovalPolicy } from "aws-cdk-lib";
import {
  IRepository,
  Repository,
  RepositoryEncryption,
  TagMutability,
} from "aws-cdk-lib/aws-ecr";
import { DockerImageAsset, Platform } from "aws-cdk-lib/aws-ecr-assets";
import { DockerImageName, ECRDeployment } from "cdk-ecr-deployment";
import { Construct } from "constructs";

export class Ecr extends Construct {
  public readonly repository: IRepository;

  constructor(scope: Construct, id: string) {
    super(scope, id);

    this.repository = new Repository(this, "Repository", {
      imageTagMutability: TagMutability.MUTABLE,
      encryption: RepositoryEncryption.AES_256,
      removalPolicy: RemovalPolicy.DESTROY,
      emptyOnDelete: true,
    });

    const image = new DockerImageAsset(this, "Image", {
      directory: path.join(__dirname, "../../"), // DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
      platform: Platform.LINUX_ARM64,
      // NOTE: `.dockerignore`ã«åˆ—æŒ™ã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–å¯¾è±¡ã¨ã™ã‚‹
      ignoreMode: IgnoreMode.DOCKER,
    });

    new ECRDeployment(this, "DeployDockerImage", {
      src: new DockerImageName(image.imageUri),
      dest: new DockerImageName(`${this.repository.repositoryUri}:latest`),
    });
  }
}

```

#### 2.2.2. ä½œæˆã—ãŸ Construct ã‚¯ãƒ©ã‚¹ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹

ã“ã“ã¾ã§ã®å·¥ç¨‹ã§ã€ECR ç”¨ã® Construct ãŒå®Œæˆã—ã¾ã—ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Construct ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã€Stack ã‚’é€šã˜ã¦ä»–ã® Construct ã¨é€£æºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:lib/sample-node-app-stack.ts
import type { StackProps } from "aws-cdk-lib";
import { Stack } from "aws-cdk-lib";
import type { Construct } from "constructs";
import { Ecr } from "./construct/ecr";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // ECR
    const ecr = new Ecr(this, "Ecr");
  }
}
```

### 2.3. VPC ã‚’ä½œæˆ

æ¬¡ã«ã€CDK ã® L2 ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ VPC ã‚’ä½œæˆã—ã¾ã™ã€‚  
ä¸Šè¨˜ã®æ§‹æˆå›³ã®é€šã‚Šã€ä»Šå›ã¯ publicSubnet 1 ã¤, privateSubnet 1 ã¤ã‚’ãã‚Œãã‚Œãƒãƒ«ãƒ AZ ã§æ§‹æˆã—ã¾ã™ã€‚

#### 2.3.1. VPC ç”¨ã® Construct ã‚’å®šç¾©

ä»¥ä¸‹ã®ã‚ˆã†ã« VPC ç”¨ã® Construct ã‚’å®šç¾©ã—ã¾ã™

```ts:lib/construct/vpc.ts
import { IVpc, IpAddresses, SubnetType, Vpc as _Vpc } from "aws-cdk-lib/aws-ec2";
import { Construct } from "constructs";

export class Vpc extends Construct {
  // NOTE: åˆ¥ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  public readonly resource: IVpc;

  constructor(scope: Construct, id: string) {
    super(scope, id);

    this.resource = new _Vpc(this, "Vpc", {
      availabilityZones: ["ap-northeast-1a", "ap-northeast-1c"],
      // NOTE: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨:16bit, ãƒ›ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨:16bit
      ipAddresses: IpAddresses.cidr("192.168.0.0/16"),
      subnetConfiguration: [
        {
          name: "public",
          cidrMask: 26, // å°è¦æ¨¡ãªã®ã§`/26`ã§ååˆ†(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 26bit, ãƒ›ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 6bit)
          subnetType: SubnetType.PUBLIC,
        },
        // NOTE: å¤–éƒ¨ã¨ã®é€šä¿¡ã¯ALBã‚’ä»‹ã—ã¦è¡Œã†(NATGatewayã‚’ä»‹ã•ãªã„)ã®ã§ã€ISOLATEDã‚’æŒ‡å®š(ECRã¨ã®æ¥ç¶šã¯VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹)
        {
          name: "isolated",
          cidrMask: 26,
          subnetType: SubnetType.PRIVATE_ISOLATED,
        },
      ],
      natGateways: 0,
      createInternetGateway: true,
    });
  }
}
```

IP ã‚¢ãƒ‰ãƒ¬ã‚¹ (CIDR) ã¨ã€ã‚µãƒ–ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

- **IP ã‚¢ãƒ‰ãƒ¬ã‚¹ (CIDR) ã«ã¤ã„ã¦**
  IP ã‚¢ãƒ‰ãƒ¬ã‚¹ (CIDR) ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-cidr-blocks.html)ã®æ¨å¥¨ã«å¾“ã„ `192.168.0.0/16` ã¨ã—ã¦ã„ã¾ã™  
  (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 16 bit, ãƒ›ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 16 bit)  
  ã¾ãŸã€æ¥µåŠ›ç„¡é§„ãªãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç”Ÿæˆã¯é¿ã‘ãŸã„ã®ã§ CIDR ãƒã‚¹ã‚¯ã¯ 26 (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 26 bit, ãƒ›ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹éƒ¨: 6 bit) ã¨ã—ã¦ã„ã¾ã™ã€‚  
  å®Ÿéš›ã®é‹ç”¨ã‚’è€ƒãˆãŸå ´åˆã¯ã€è¦æ¨¡ã®æ‹¡å¤§ãªã©ã‚‚è€ƒæ…®ã—ã¦ã‚‚ã†å°‘ã—å¤§ãã‚ã® CIDR ãƒã‚¹ã‚¯ã®æ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

- **ã‚µãƒ–ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦**
  ã„ãšã‚Œã® privateSubnet ã‚‚ç›´æ¥ã®å¤–éƒ¨é€šä¿¡ã¯è¡Œã‚ãªãšã€NAT Gateway ã‚‚å¿…è¦ã¨ã—ãªã„ã®ã§ã€ã‚µãƒ–ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—ã¯ `PRIVATE_ISOLATED` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚  
  ã‚µãƒ–ãƒãƒƒãƒˆã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¾ã—ãŸ  
  [enum SubnetType Â· AWS CDK](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2.SubnetType.html#members)

#### 2.3.2. VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ

ä¸Šè¨˜ã®æ§‹æˆå›³ã®é€šã‚Šã€S3 / CloudWatch / ECR / Secrets Manager ç”¨ã® VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚  
VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¯ã€ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å‹ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ã® 2 ç¨®é¡ãŒã‚ã‚Šã€ä¸Šè¨˜ã® 3 ã¤ã®ã†ã¡ã€S3 ã¯ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å‹ã§ã€CloudWatch / ECR / Secrets Manager ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ã¨ãªã‚‹ã®ã§ã€ãã‚Œãã‚Œç¨®é¡ã«å¿œã˜ãŸå½¢ã§ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

(å„ç¨®é¡ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¾ã—ãŸ)
[AWS PrivateLink ã®æ¦‚å¿µ - Amazon Virtual Private Cloud](https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/concepts.html#concepts-vpc-endpoints)

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¾ã™

```diff ts:lib/construct/vpc.ts
+ import {
+   GatewayVpcEndpointAwsService,
+   IVpc,
+   InterfaceVpcEndpointAwsService,
+   IpAddresses,
+   SubnetType,
+   Vpc as _Vpc
+ } from "aws-cdk-lib/aws-ec2"
- import { IpAddresses, SubnetType, Vpc as _Vpc } from "aws-cdk-lib/aws-ec2";
import { Construct } from "constructs";

export class Vpc extends Construct {
   /** çœç•¥ */
  constructor(scope: Construct, id: string) {
    super(scope, id);

    this.resource = new _Vpc(this, "Vpc", {
      /** çœç•¥ */
    });

+   // NOTE: VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
+   this.resource.addInterfaceEndpoint("EcrEndpoint", {
+     service: InterfaceVpcEndpointAwsService.ECR,
+   });
+   this.resource.addInterfaceEndpoint("EcrDkrEndpoint", {
+     service: InterfaceVpcEndpointAwsService.ECR_DOCKER,
+   });
+   this.resource.addInterfaceEndpoint("CwLogsEndpoint", {
+     service: InterfaceVpcEndpointAwsService.CLOUDWATCH_LOGS,
+   });
+   this.resource.addInterfaceEndpoint("SecretsManagerEndpoint", {
+     service: InterfaceVpcEndpointAwsService.SECRETS_MANAGER,
+   });
+   this.resource.addGatewayEndpoint("S3Endpoint", {
+     service: GatewayVpcEndpointAwsService.S3,
+     subnets: [
+       {
+         subnets: this.resource.isolatedSubnets,
+       },
+     ],
+   });
  }
}
```

#### 2.3.3. ä½œæˆã—ãŸ Construct ã‚¯ãƒ©ã‚¹ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹

ã“ã“ã¾ã§ã®å·¥ç¨‹ã§ã€Vpc ç”¨ã® Construct ãŒå®Œæˆã—ã¾ã—ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Construct ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã€Stack ã‚’é€šã˜ã¦ä»–ã® Construct ã¨é€£æºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:lib/sample-node-app-stack.ts
import type { StackProps } from "aws-cdk-lib";
import { Stack } from "aws-cdk-lib";
import type { Construct } from "constructs";
import { Ecr } from "./constructs/ecr";
import { Vpc } from "./construct/vpc";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // ECR
    const ecr = new Ecr(this, "Ecr");

    // VPC
    const vpc = new Vpc(this, "Vpc");
  }
}
```

### 2.4. ALB ã‚’ä½œæˆ

#### 2.4.1. ALB ç”¨ã® Construct ã‚’å®Ÿè£…

ä¸Šè¨˜ã®æ§‹æˆå›³ã®é€šã‚Šã€ALB ã¯ publicSubnet ã«é…ç½®ã—ã¾ã™ã€‚
ä»Šå›ã€ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹ã®ã¯ ECS ã«ãªã‚Šã¾ã™ãŒã€ALB ã¨ ECS ã®é€šä¿¡ã¯ HTTP ã§è¡Œã†ãŸã‚ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ HTTP ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ALB ã¨ ECS ã®é€šä¿¡ã‚’å›³ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![alb-ecs.drawio.png](https://storage.googleapis.com/zenn-user-upload/70b65ff0cbfe-20240503.png)

ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™

```ts:lib/construct/alb.ts
import { IConnectable, SubnetType, type IVpc } from "aws-cdk-lib/aws-ec2";
import type { IApplicationLoadBalancer } from "aws-cdk-lib/aws-elasticloadbalancingv2";
import {
  ApplicationLoadBalancer,
  ApplicationProtocol,
  ApplicationTargetGroup,
  Protocol,
  TargetType,
} from "aws-cdk-lib/aws-elasticloadbalancingv2";
import { Construct } from "constructs";

interface AlbProps {
  vpc: Vpc;
  resourceName: string;
  securityGroup: SecurityGroup;
  subnets: SubnetSelection;
}

export class Alb extends Construct {
  /**
   * æ¥ç¶šå¯èƒ½ãªALBã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
   * @example ãƒªã‚½ãƒ¼ã‚¹ã‚’ALBã¨æ¥ç¶šã™ã‚‹éš›ã«ã¯ã€ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ¥ç¶šã‚’è¡Œã†
   * ```typescript
   * // `allowDefaultPortTo`ã®å¼•æ•°ã«ã¯æ¥ç¶šã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š
   * connectableInstance.connections.allowDefaultPortTo(ecsService);
   * ```
   */
  public readonly connectableInstance: IConnectable;

  private readonly resource: IApplicationLoadBalancer;

  constructor(scope: Construct, id: string, props: AlbProps) {
    super(scope, id);

    // NOTE: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
    const targetGroup = new ApplicationTargetGroup(this, "AlbTargetGroup", {
      vpc: props.vpc,
      targetType: TargetType.IP,
      protocol: ApplicationProtocol.HTTP,
      port: 80,
      healthCheck: {
        path: "/",
        port: "80",
        protocol: Protocol.HTTP,
        healthyHttpCodes: "200",
      },
    });

    // NOTE: ALBã®ä½œæˆ
    this.resource = new ApplicationLoadBalancer(this, "Alb", {
      vpc: props.vpc,
      internetFacing: true,
      vpcSubnets: props.vpc.selectSubnets({ subnetType: SubnetType.PUBLIC }),
    });

    // NOTE: ãƒªã‚¹ãƒŠãƒ¼ã®ä½œæˆ
    this.resource.addListener("AlbListener", {
      protocol: ApplicationProtocol.HTTP,
      defaultTargetGroups: [targetGroup],
    });

    this.connectableInstance = this.resource;
  }
}

```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`IConnectable` å‹ã® `connectableInstance` ã‚’ public å¤‰æ•°ã¨ã—ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚  
ã“ã® `connectableInstance` ã‚’åˆ©ç”¨ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€ALB ã¨ ECS ã®æ¥ç¶šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
alb.connectableInstance.connections.allowDefaultPortTo(ecsService);
```

#### 2.4.2. å¤–éƒ¨ã‹ã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ä¸Šè¿°ã®é€šã‚Šä»Šå›ã®æ§‹æˆã§ã¯ã€ECS ãŒ ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãªã‚Šã¾ã™ã€‚  
ã“ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç™»éŒ²ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« listener ã‚’ä½¿ç”¨ã—ã¦è¡Œã„ã¾ã™ã€‚

```ts
alb.listener.addTargets("Ecs", {
  /** çœç•¥ */
});
```

ã“ã‚Œã‚’ Stack ã‚’é€šã˜ã¦è¡Œãˆã‚‹ã‚ˆã†ã«ã€å¤–éƒ¨ã‹ã‚‰ listener ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```diff ts:lib/construct/alb.ts
- import type { IApplicationLoadBalancer } from "aws-cdk-lib/aws-elasticloadbalancingv2";
+ import type {
+   IApplicationListener,
+   IApplicationLoadBalancer,
+ } from "aws-cdk-lib/aws-elasticloadbalancingv2";

export class Alb extends Construct {
  public readonly value: ApplicationLoadBalancer;

  constructor(scope: Construct, id: string, props: AlbProps) {
    /** çœç•¥ */
  }

+ /**
+  * ALBã®ãƒªã‚¹ãƒŠãƒ¼
+  */
+ get listener(): IApplicationListener {
+    // NOTE: ãƒªã‚¹ãƒŠãƒ¼ã¯constructorå†…ã§1ã¤ã—ã‹ä½œæˆã—ãªã„ãŸã‚ã€é…åˆ—ã®ä¸€ç•ªç›®ã®è¦ç´ ã‚’å–å¾—
+    //       publicå¤‰æ•°ã«ã¯`addListener`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—å¯èƒ½ãªå¤‰æ•°ãŒãªã„ãŸã‚ã€é…åˆ—ã®è¦ç´ ãŒ1ã¤ä»¥å¤–ã®å ´åˆã¯è€ƒæ…®ã—ãªã„
+    return this.resource.listeners[0];
+ }
}
```

#### 2.4.3. ä½œæˆã—ãŸ Construct ã‚¯ãƒ©ã‚¹ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ã« Construct ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¾ã™

```ts:lib/sample-node-app-stack.ts
import type { StackProps } from "aws-cdk-lib";
import { Stack } from "aws-cdk-lib";
import type { Construct } from "constructs";

import { Alb } from "./constructs/alb";
import { Ecr } from "./constructs/ecr";
import { Vpc } from "./construct/vpc";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // ECR
    const ecr = new Ecr(this, "Ecr");

    // VPC
    const vpc = new Vpc(this, "Vpc");

    // ALB
    const alb = new Alb(this, "Alb", {
      vpc: vpc.resource,
    });
  }
}
```

### 2.5. RDS ã‚’ä½œæˆ

ã“ã“ã¾ã§ã®æ§‹ç¯‰ã«ã‚ˆã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ VCP å†…ã® AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  
ã“ã“ã‹ã‚‰ ECS ã‚’æ§‹ç¯‰ã—ãŸã„ã®ã§ã™ãŒã€ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ DB ã¨ã®æ¥ç¶šãŒå¿…è¦ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç«‹ã¡ä¸Šã’æ™‚ã« DB ã¨ã®æ¥ç¶šç¢ºç«‹ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã‚‹ç”¨ã«ãªã£ã¦ã„ã¾ã™ã€‚  
ã“ã®æ™‚ã«ã€DB ãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ãªã„çŠ¶æ…‹ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ECS ã‚ˆã‚Šå…ˆã« RDS ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

RDS ã®æ§‹ç¯‰æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. Construct ã‚’å®šç¾©
2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
3. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
4. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—

#### 2.5.1. Construct ã‚’å®šç¾©

ã¾ãšã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« RDS ç”¨ã® Construct ã‚’å®šç¾©ã—ã¾ã™

```ts:lib/construct/rds.ts
import { Construct } from "constructs";

export class Rds extends Construct {
  constructor(scope: Construct, id: string) {
    super(scope, id);
  }
}
```

#### 2.5.2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç”Ÿæˆã‚’è¡Œã„ãŸã„ã®ã§ã™ãŒã€CDK ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã®ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«è‰¯ããªã„ã®ã§ã€Secrets Manager ã«ä¿å­˜ã™ã‚‹æ–¹é‡ã§è€ƒãˆã¾ã™ã€‚  
ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€`Credentials` ã‚¯ãƒ©ã‚¹ã® `fromGeneratedSecret` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```diff ts:lib/construct/rds.ts
+ import { Credentials } from "aws-cdk-lib/aws-rds";

+ interface RdsProps {
+   /**
+    * ãƒ¦ãƒ¼ã‚¶å
+    * - <your_name>ã®å½¢å¼(ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹)ã§æŒ‡å®šã™ã‚‹
+    * @example "taro_yamada"
+    */
+   readonly username: string;
+ }

export class Rds extends Construct {
-  constructor(scope: Construct, id: string) {
+  constructor(scope: Construct, id: string, props: RdsProps) {
    super(scope, id);

+   // NOTE: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦Secrets Managerã«ä¿å­˜
+   const credentials = Credentials.fromGeneratedSecret(props.username);
  }
}
```

#### 2.5.3 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

ç¶šã„ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚
ä»Šå›ã¯ç·´ç¿’ç”¨ (å‹‰å¼·ç”¨) ã§ã‚ã‚Šã€é«˜æ€§èƒ½ã‚ˆã‚Šä½ä¾¡æ ¼ã‚’æ±‚ã‚ãŸã„ã§ã™ã€‚ãã®ç‚ºã€Aurora ã‚’ä½¿ç”¨ã—ãªã„ MySQL ã‚’é¸æŠã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚µã‚¤ã‚ºã¯ MICRO ã‚’é¸æŠã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ALB ã¨åŒæ§˜ã«ã€ECS ã¨æ¥ç¶šã‚’è¡Œã†ãŸã‚ã« `IConnectable` å‹ã® `connectableInstance` ã‚’ public å¤‰æ•°ã¨ã—ã¦å…¬é–‹ã—ã¾ã™

```diff ts:lib/construct/rds.ts
+ import { InstanceClass, InstanceSize, InstanceType, type SecurityGroup, type SubnetSelection, type Vpc } from "aws-cdk-lib/aws-ec2";
+ import { Credentials, DatabaseInstance, DatabaseInstanceEngine, NetworkType, PostgresEngineVersion } from "aws-cdk-lib/aws-rds";
- import { Credentials } from "aws-cdk-lib/aws-rds";

interface RdsProps {
+ /**
+  * RDSã‚’ä½œæˆã™ã‚‹VPC
+  */
+ readonly vpc: IVpc;
+ /**
+  * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
+  * - <database_name>ã®å½¢å¼(ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹)ã§æŒ‡å®šã™ã‚‹
+  * @example "sample_database"
+  */
+ readonly databaseName: string;
  /**
   * ãƒ¦ãƒ¼ã‚¶å
   * - <your_name>ã®å½¢å¼(ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹)ã§æŒ‡å®šã™ã‚‹
   * @example "taro_yamada"
   */
  readonly username: string;
}

export class Rds extends Construct {
+ /**
+  * æ¥ç¶šå¯èƒ½ãªRDSã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
+  * - ãƒªã‚½ãƒ¼ã‚¹ã‚’RDSã«æ¥ç¶šã™ã‚‹éš›ã«ã¯ã€ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ¥ç¶šã‚’è¡Œã†
+  * ```typescript
+  * // `allowDefaultPortFrom`ã®å¼•æ•°ã«ã¯æ¥ç¶šã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š
+  * connectableInstance.connections.allowDefaultPortFrom(ecsService);
+  * ```
+  */
+ public readonly connectableInstance: IConnectable;

  constructor(scope: Construct, id: string, props: RdsProps) {
    super(scope, id);
    /** çœç•¥ */
    // NOTE: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦Secrets Managerã«ä¿å­˜
    const credentials = Credentials.fromGeneratedSecret(props.username);

+   // NOTE: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
+   const instance = new DatabaseInstance(this, "MysqlInstance", {
+     engine: DatabaseInstanceEngine.mysql({
+       version: MysqlEngineVersion.VER_8_0,
+     }),
+     instanceType: InstanceType.of(
+       InstanceClass.T4G,
+       InstanceSize.MICRO,
+     ),
+     databaseName: props.databaseName,
+     vpc: props.vpc,
+     vpcSubnets: props.vpc.selectSubnets({
+       subnetType: SubnetType.PRIVATE_ISOLATED,
+     }),
+     networkType: NetworkType.IPV4,
+     availabilityZone: "ap-northeast-1a",
+     credentials,
+     removalPolicy: RemovalPolicy.DESTROY,
+   });

+   this.connectableInstance = instance;
  }
}
```

#### 2.5.4. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—

ç¶šã„ã¦ã€Secrets Manager ã«ä¿å­˜ã—ãŸ RDS ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’ã€ECS ã®ã‚¿ã‚¹ã‚¯ã«æŒ‡å®šã™ã‚‹ãŸã‚ã« `secrets` ã¨ã„ã†å¤‰æ•°ã‚’ public å¤‰æ•°ã¨ã—ã¦å…¬é–‹ã—ã¾ã™  
(ã“ã®å¤‰æ•°ã‚’é€šã˜ã¦ RDS ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™)

å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™

```diff ts:lib/construct/rds.ts
+ import { Secret } from "aws-cdk-lib/aws-secretsmanager";

export class Rds extends Construct {
+ /**
+  * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±
+  *
+  * â€»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ECSã‚³ãƒ³ãƒ†ãƒŠã®`secrets`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«åŠ å·¥ã›ãšã«æŒ‡å®šå¯èƒ½
+  * ```typescript
+  * // ECSã®ã‚¿ã‚¹ã‚¯å®šç¾©ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹
+  * taskDefinition.addContainer("EcsContainer", {
+  *   secrets: rds.secrets,
+  * });
+  * ```
+  */
+ public readonly secrets: { [key: string]: Secret };

  constructor(scope: Construct, id: string, props: RdsProps) {
    // çœç•¥

+ã€€// NOTE: IConnectableã¯`secret`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒãŸãªã„ã®ã§ã€thisã§ã¯ãªãå®šæ•°ã®`instance`ã‚’åˆ©ç”¨ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—
+   const secret = instance.secret;
+   if (!secret) throw new Error("RDSã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");

+   this.secrets = this.getDatabaseSecrets(secret);
  }

+ /**
+  * RDSã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹
+  */
+ private getDatabaseSecrets(secret: ISecret): { [key: string]: Secret } {
+   return {
+     DATABASE_ENGINE: Secret.fromSecretsManager(secret, "engine"),
+     DATABASE_USERNAME: Secret.fromSecretsManager(secret, "username"),
+     DATABASE_PASSWORD: Secret.fromSecretsManager(secret, "password"),
+     DATABASE_HOST: Secret.fromSecretsManager(secret, "host"),
+     DATABASE_PORT: Secret.fromSecretsManager(secret, "port"),
+     DATABASE_NAME: Secret.fromSecretsManager(secret, "dbname"),
+   };
+ }
}
```

#### 2.5.5. ä½œæˆã—ãŸ Construct ã‚¯ãƒ©ã‚¹ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ã« Construct ã‚’ Stack ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¾ã™

```diff ts:lib/sample-node-app-stack.ts
+ import { Rds } from "./construct/rds";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps, readonly resourceName = "sample-node-app") {
    super(scope, id, props);

    /** çœç•¥ */

    // ALB
    const alb = new Alb(this, "Alb", {
      vpc: vpc.value,
      resourceName,
      securityGroup: albSecurityGroup,
      subnets: vpc.getPublicSubnets(),
    });

+   // RDS
+   new Rds(this, "Rds", {
+     vpc: vpc.value,
+     databaseName: "sample_database",
+     username: "ren_yamanashi",
+   });
  }
}
```

### 2.6. ECS ã‚’ä½œæˆ

RDS ã‚’æ§‹ç¯‰ã—ã€ã•ã‚‰ã« Secrets Manager ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹æº–å‚™ãŒã§ããŸã®ã§ã€ç¶šã„ã¦ ECS ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚  
ECS ã®æ§‹ç¯‰æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ»ã‚¿ã‚¹ã‚¯å®šç¾©ã®ä½œæˆ
2. ã‚¿ã‚¹ã‚¯å®šç¾©ã« ECR ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
3. ECS ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
4. ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã« ECS ã‚’è¿½åŠ 

#### 2.6.1. ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ»ã‚¿ã‚¹ã‚¯å®šç¾©ã®ä½œæˆ

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã« ECS ç”¨ã® Construct ã‚’å®šç¾©ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åŠã³ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

```ts:lib/construct/ecs.ts
import { Construct } from "constructs";
import { Cluster, CpuArchitecture, FargateTaskDefinition } from "aws-cdk-lib/aws-ecs";
import type { IVpc } from "aws-cdk-lib/aws-ec2";

interface EcsProps {
  /**
   * ECSã‚’ä½œæˆã™ã‚‹VPC
   */
  readonly vpc: IVpc;
}

export class Ecs extends Construct {
  constructor(scope: Construct, id: string, props: EcsProps) {
    super(scope, id);

    // NOTE: ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆ
    const cluster = new Cluster(this, "EcsCluster", {
      vpc: props.vpc,
    });

    // NOTE: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ä½œæˆ
    const taskDefinition = new FargateTaskDefinition(this, "EcsTaskDefinition", {
      cpu: 256,
      memoryLimitMiB: 512,
      runtimePlatform: {
        cpuArchitecture: CpuArchitecture.ARM64,
      },
    });
  }
}

```

#### 2.6.2. ã‚¿ã‚¹ã‚¯å®šç¾©ã« ECR ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 

ç¶šã„ã¦ã€ã‚¿ã‚¹ã‚¯å®šç¾©ã« ECR ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚  
ã¾ãŸã€ECS ã®ãƒ­ã‚°æƒ…å ±ãŒ CloudWatch Logs ã«é€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã« AwsLogDriver ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚  
ä»Šå›ã¯æœ¬ç•ªç’°å¢ƒã§é‹ç”¨ã™ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ãƒ­ã‚°ã®ä¿æŒæœŸé–“ã¯ 1 æ—¥ã¨çŸ­ãè¨­å®šã—ã¦ãŠãã¾ã™ã€‚

```diff ts:lib/construct/ecs.ts
+ import { AwsLogDriver, Cluster, ContainerImage, CpuArchitecture, FargateTaskDefinition } from "aws-cdk-lib/aws-ecs";
+ import { RetentionDays } from "aws-cdk-lib/aws-logs";
+ import type { IRepository } from "aws-cdk-lib/aws-ecr";
- import { Cluster, CpuArchitecture, FargateTaskDefinition } from "aws-cdk-lib/aws-ecs";

interface EcsProps {
  /**
   * ECSã‚’ä½œæˆã™ã‚‹VPC
   */
  readonly vpc: IVpc;
+ /**
+  * ECRãƒªãƒã‚¸ãƒˆãƒª
+  */
+ readonly repository: IRepository;
+ /**
+  * ECSã¨æ¥ç¶šã‚’è¡Œã†ãƒªã‚½ãƒ¼ã‚¹
+  */
+ readonly connections: { alb: IConnectable; rds: IConnectable };
+ /**
+  * ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã™ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
+  */
+ readonly secrets: { [key: string]: Secret };
}

export class Ecs extends Construct {
  constructor(scope: Construct, id: string, props: EcsProps) {
    super(scope, id);

    /** çœç•¥ */

+   // NOTE: ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
+   const logGroup = new LogGroup(this, "LogGroup", {
+     logGroupName: "/ecs/sample-node-app",
+     removalPolicy: RemovalPolicy.DESTROY,
+     retention: RetentionDays.ONE_DAY,
+   });
+   const logDriver = new AwsLogDriver({
+     logGroup,
+     streamPrefix: "container",
+   });

    // NOTE: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ä½œæˆ
    const taskDefinition = new FargateTaskDefinition(this, "EcsTaskDefinition", {
      /** çœç•¥ */
    });
+   taskDefinition.addContainer("Container", {
+     image: ContainerImage.fromEcrRepository(props.ecrRepository),
+     portMappings: [{ containerPort: 80, hostPort: 80 }],
+     secrets: props.secrets,
+     logging: logDriver,
+   });
  }
}
```

#### 2.6.3. ECS ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ

ECS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ»ã‚¿ã‚¹ã‚¯å®šç¾©ãŒä½œæˆã§ãã€ã•ã‚‰ã«ã‚³ãƒ³ãƒ†ãƒŠã®è¿½åŠ ã‚‚è¡ŒãˆãŸã®ã§ã€ç¶šã„ã¦ ECS ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¦ã„ãã¾ã™
ä¸Šè¨˜ã®æ§‹æˆå›³ã®é€šã‚Šã€ä»Šå›ã¯ ECS ã‚’ãƒãƒ«ãƒ AZ ã§æ§‹æˆã™ã‚‹ã®ã§ã€å¿…è¦ãªã‚¿ã‚¹ã‚¯æ•°ã¯ 2 ã¨ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ä½œæˆã—ãŸ ECS ã‚µãƒ¼ãƒ“ã‚¹ã¨ ALB / RDS ã®æ¥ç¶šã‚’è¡Œã†ãŸã‚ã«ã€`IConnectable` ã‚’åˆ©ç”¨ã—ãŸå®Ÿè£…ã‚‚è¡Œã„ã¾ã™ã€‚

```diff ts:lib/construct/ecs.ts
+ import { AwsLogDriver, Cluster, ContainerImage, CpuArchitecture, FargateService, FargateTaskDefinition, TaskDefinitionRevision } from "aws-cdk-lib/aws-ecs";
- import { AwsLogDriver, Cluster, ContainerImage, CpuArchitecture, FargateTaskDefinition } from "aws-cdk-lib/aws-ecs";
+ import type { SecurityGroup, SubnetSelection, Vpc } from "aws-cdk-lib/aws-ec2";
- import type { Vpc } from "aws-cdk-lib/aws-ec2";

interface EcsProps {
  /**
   * ECSã‚’ä½œæˆã™ã‚‹VPC
   */
  readonly vpc: IVpc;
  /**
   * ECRãƒªãƒã‚¸ãƒˆãƒª
   */
  readonly repository: IRepository;
  /**
   * ECSã¨æ¥ç¶šã‚’è¡Œã†ãƒªã‚½ãƒ¼ã‚¹
   */
  readonly connections: { alb: IConnectable; rds: IConnectable };
  /**
   * ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã™ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
   */
  readonly secrets: { [key: string]: Secret };
}

export class Ecs extends Construct {
+ /**
+  * ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«æŒ‡å®šã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹
+  */
+ public readonly loadBalancerTarget: IEcsLoadBalancerTarget;

  constructor(scope: Construct, id: string, props: EcsProps) {
    super(scope, id);

    /** çœç•¥ */

    // NOTE: ã‚¿ã‚¹ã‚¯å®šç¾©ã®ä½œæˆ
    /** çœç•¥ */
    taskDefinition.addContainer("EcsContainer", {
      /** çœç•¥ */
    });

+   // NOTE: Fargateèµ·å‹•ã‚¿ã‚¤ãƒ—ã§ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
+   this.fargateService = new FargateService(this, "EcsFargateService", {
+     cluster,
+     taskDefinition,
+     desiredCount: 2,
+     securityGroups: [props.securityGroup],
+     vpcSubnets: props.vpc.selectSubnets({
+       subnetType: SubnetType.PRIVATE_ISOLATED,
+     }),
+     taskDefinitionRevision: TaskDefinitionRevision.LATEST,
+   });

+   // NOTE: FargateServiceã¯`default port`ã‚’æŒãŸãªã„ãŸã‚ã€æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹
+   fargateService.connections.allowFrom(props.connections.alb, Port.tcp(80)); // IConnectableã‚’åˆ©ç”¨ã—ã¦ECSã¨ALBã‚’æ¥ç¶š
+   props.connections.rds.connections.allowDefaultPortFrom(fargateService); // IConnectableã‚’åˆ©ç”¨ã—ã¦ECSã¨RDSã‚’æ¥ç¶š
```

#### 2.6.4. ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã« ECS ã‚’è¿½åŠ 

æœ€å¾Œã«ã€Stack å´ã§ ECS ç”¨ã® Construct ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã€ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ç™»éŒ²ã—ã¾ã™ã€‚

```diff ts:lib/sample-node-app-stack.ts
+ import { Ecs } from "./construct/ecs";
+ import { Duration, Stack } from "aws-cdk-lib";
- import { Stack } from "aws-cdk-lib";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps, readonly resourceName = "sample-node-app") {
    super(scope, id, props);

    /** çœç•¥ */

+   const ecs = new Ecs(this, "Ecs", {
+     vpc: vpc.value,
+     repository: ecr.repository,
+     ecrRepository: repository,
+     connections: {
+       alb: alb.connectableInstance,
+       rds: rds.connectableInstance,
+     },
+     secrets: rds.secrets,
+   });

+   // NOTE: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
+   alb.addTargets("Ecs", {
+     port: 80,
+     targets: [ecs.fargateService],
+     healthCheck: {
+       path: "/",
+       interval: Duration.minutes(1),
+     },
+   });
  }
}

```

ã“ã“ã¾ã§ã§ã€æœ€åˆã®æ§‹æˆå›³ã®é€šã‚Šã®æ§‹ç¯‰ãŒã§ãã¾ã—ãŸã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã€å®Ÿéš›ã« ALB ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦å‹•ä½œç¢ºèªã‚’ã—ãŸã„ã®ã§ã€ALB ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãŠãã¾ã™ã€‚

```diff ts:lib/sample-node-app-stack.ts
+ import { CfnOutput, Duration, Stack } from "aws-cdk-lib";
- import { Duration, Stack } from "aws-cdk-lib";

export class SampleNodeAppStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps, readonly resourceName = "sample-node-app") {
    super(scope, id, props);

    /** çœç•¥ */

    // NOTE: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
    alb.addTargets("Ecs", {
      /** çœç•¥ */
    });

+   // NOTE: ALBã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å‡ºåŠ›
+   new CfnOutput(this, "LoadBalancerDomainName", {
+     value: alb.value.loadBalancerDnsName,
+   });
  }
}

```

```diff
cdk deploy
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¨ã€ALB ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒå‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ãã“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚

```bash
# `/`ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
curl http://<ALBã®ãƒ‰ãƒ¡ã‚¤ãƒ³å>
Hello World
```

```bash
# `/posts`ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
curl -X POST http://<ALBã®ãƒ‰ãƒ¡ã‚¤ãƒ³å>/posts -H "Content-Type: application/json" -d '{"title": "sample post"}'
{"id":"4bc54a3f-9c9d-4662-9d45-856baf434ea2","title":"sample post"}
```

```bash
# `/posts`ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
curl http://<ALBã®ãƒ‰ãƒ¡ã‚¤ãƒ³å>/posts
{"id":"4bc54a3f-9c9d-4662-9d45-856baf434ea2","title":"sample post"}
```

ç„¡äº‹ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¸°ã£ã¦ãã¾ã—ãŸï¼

## 3. ã¾ã¨ã‚

ä»Šå›ã¯ã€AWS CDK ã‚’ä½¿ç”¨ã—ã¦ ECS (Fargate) ã¨ RDS ã‚’ãƒãƒ«ãƒ AZ æ§‹æˆã§æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ãŸã€‚
ç§ã¯ä»Šå›ãŒ CDK ã‚’è§¦ã‚‹ã®ãŒåˆã‚ã¦ã ã£ãŸã®ã§ã™ãŒã€å„ãƒªã‚½ãƒ¼ã‚¹ã¨ã®ã¤ãªãŒã‚Šã‚’ç†è§£ã—ãªãŒã‚‰æ§‹ç¯‰ã§ãã€ã¨ã¦ã‚‚é–‹ç™ºä½“é¨“ãŒè‰¯ã‹ã£ãŸã§ã™ã€‚
ä»Šå¾Œã¯ä»–ã® AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦è§¦ã‚ŒãŸã‚Šã€IPv6 æ§‹æˆãªã©ã‚’è©¦ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

### 3.1. æˆæœç‰©

ä»Šå›æœ€çµ‚çš„ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™
https://github.com/ren-yamanashi/ecs-fargate-cdk

### 3.2. å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ

ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸï¼

- VPC Construct ã® API Reference
  https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2.Vpc.html
- SubnetType ã® API Reference
  https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2.SubnetType.html#members
- VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¨®é¡ã«ã¤ã„ã¦ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  https://docs.aws.amazon.com/ja_jp/vpc/latest/privatelink/concepts.html#concepts-vpc-endpoints
- VPC CIDR ãƒ–ãƒ­ãƒƒã‚¯ã«ã¤ã„ã¦ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-cidr-blocks.html
- RDS ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹æ–¹æ³•
  https://dev.classmethod.jp/articles/automatically-generate-a-password-with-cdk/

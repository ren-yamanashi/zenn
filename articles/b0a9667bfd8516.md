---
title: "CDK Toolkit Library ã§å¯¾è©±çš„ãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’å®Ÿç¾ã™ã‚‹"
published: true
cssclass: zenn
emoji: "ğŸ•Œ"
type: "tech"
topics: ["AWS", "TypeScript", "AWS CDK"]
url: "https://zenn.dev/yamaren/articles/b0a9667bfd8516"
---

ã“ã®è¨˜äº‹ã§ã¯ã€CDK Toolkit Library ã‚’ä½¿ç”¨ã—ã¦å¯¾è©±çš„ãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

## CDK Toolkit Library ã¨ã¯

CDK Toolkit Library ([@aws-cdk/toolkit-lib](https://www.npmjs.com/package/@aws-cdk/toolkit-lib)) (ä»¥ä¸‹ Toolkit Library) ã¨ã¯ã€AWS CDK CLI (ä»¥ä¸‹ CDK CLI) ã®æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã€å·®åˆ†ç¢ºèªã€åˆæˆãªã©ï¼‰ã‚’ TypeScript ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã‹ã‚‰ç›´æ¥å®Ÿè¡Œã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

ã“ã® Toolkit Library ã¨ CDK CLI ã«ã¯ã„ãã¤ã‹ã®é•ã„ãŒã‚ã‚Šã€ãã®ä¸€ã¤ã¨ã—ã¦ã€Œã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã‚’å¿…è¦ã¨ã™ã‚‹ã‹ã©ã†ã‹ã€ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

CDK CLI ã‚’ä½¿ç”¨ã—ãŸå ´åˆã€`deploy` ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹éš›ã« `--require-approval` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã§ãã€ã“ã®å€¤ã«ã‚ˆã£ã¦ã€ã€Œã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’å¿…è¦ã¨ã™ã‚‹ã‹ã€ã‚’æŒ‡å®šã§ãã¾ã™ã€‚  
ã¾ãŸã€ã“ã® `--require-approval` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ `BROADENING` ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™(â€»1)

ä¸€æ–¹ã€Toolkit Library ã®æ–¹ã§ã¯ `RequireApproval` ã«ã‚ˆã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã®æœ‰ç„¡ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã¯ã§ããšã€è¿½åŠ ã®è¨­å®šã‚’è¡Œã‚ãªã„é™ã‚Šå¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã‚’å¿…è¦ã¨ã—ã¾ã›ã‚“ã€‚  
(ã“ã‚Œã¯ `RequireApproval` ã« `NEVER` ã‚’æŒ‡å®šã—ãŸæŒ™å‹•ã¨ã€ã»ã¨ã‚“ã©åŒã˜ã«ãªã‚Šã¾ã™)

â€»1. å‚ç…§:  

- [AWS CDK API Reference / enum RequireApproval](https://docs.aws.amazon.com/cdk/api/v2/docs/@aws-cdk_cloud-assembly-schema.RequireApproval.html)  
- [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ç®‡æ‰€](https://github.com/aws/aws-cdk-cli/blob/aws-cdk%40v2.1026.0/packages/aws-cdk/lib/cli/io-host/cli-io-host.ts#L170)

## Toolkit Library ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’å®Ÿç¾ã™ã‚‹

å…ˆè¿°ã—ãŸã‚ˆã†ãªã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’æ±‚ã‚ãŸã‚Šã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ãè¾¼ã‚€ã¨ã„ã£ãŸæ©Ÿèƒ½ã¯ã€CDK ã§ã¯ IO Host ã¨ã„ã†ä»•çµ„ã¿ã«ã‚ˆã£ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚  
å…·ä½“çš„ã«ã€CDK CLI ã§ã¯ [`CliIoHost` ã‚¯ãƒ©ã‚¹](https://github.com/aws/aws-cdk-cli/blob/aws-cdk%40v2.1026.0/packages/aws-cdk/lib/cli/io-host/cli-io-host.ts)ã€Toolkit Library ã§ã¯ [`NonInteractiveIoHost` ã‚¯ãƒ©ã‚¹](https://github.com/aws/aws-cdk-cli/blob/aws-cdk%40v2.1026.0/packages/@aws-cdk/toolkit-lib/lib/toolkit/non-interactive-io-host.ts)ã§ãã®ã‚ˆã†ãªä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™

(å…ˆã»ã© Toolkit Library ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨è¿°ã¹ã¾ã—ãŸãŒã€ã“ã‚Œã¯ Toolkit Library ãŒä½¿ç”¨ã™ã‚‹ `NonInteractiveIoHost` ã‚¯ãƒ©ã‚¹ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’å¿…è¦ã¨ã—ãªã„å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã§ã™)

ã“ã® `NonInteractiveIoHost` ã¨ã„ã†åå‰ã®é€šã‚Šã€Toolkit Library ã§ä½¿ç”¨ã™ã‚‹ IO Host ã«ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹é™ã‚Šã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã¯å¸¸ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã—ã¾ã†ç‚ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Toolkit Library ã«æŒ‡å®šã™ã‚‹ ioHost ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts
// declare class InteractiveIoHost implements IIoHost { /** ... */ }
import { Toolkit } from '@aws-cdk/toolkit-lib';

new Toolkit({
  // ...
  ioHost: new InteractiveIoHost(),
});
```

<br />

ãŸã ã€ã“ã“ã§æŒ‡å®šã™ã‚‹ IO Host ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹(`CliIoHost`ã‚¯ãƒ©ã‚¹ãªã©)ã¯ã€aws-cdk-cli ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚(`NonInteractiveIoHost` ã‚¯ãƒ©ã‚¹ã‚’é™¤ã„ã¦)

ãã®ãŸã‚ã€Toolkit Library ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«ã€IO Host ã®ä»•çµ„ã¿ã‚’å®Ÿç¾ã—ãŸã‚¯ãƒ©ã‚¹ã‚’è‡ªå‰ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

::::details ã‚³ãƒ¼ãƒ‰ä¾‹

```ts
import * as readline from 'node:readline/promises';
import * as util from 'node:util';
import { IIoHost, IoRequest, NonInteractiveIoHost, NonInteractiveIoHostProps, PermissionChangeType } from '@aws-cdk/toolkit-lib';
import { RequireApproval } from 'aws-cdk-lib/cloud-assembly-schema';

type IoRequestMessage = IoRequest<
  { permissionChangeType: PermissionChangeType; motivation?: string; concurrency?: number; responseDescription?: string; } | undefined,
  unknown
>;

interface InteractiveIoHostProps extends NonInteractiveIoHostProps {
  /**
   * æ‰¿èªãŒå¿…è¦ãªå¤‰æ›´ã®ãƒ¬ãƒ™ãƒ«
   * @default RequireApproval.BROADENING
   */
  readonly requireApproval?: RequireApproval;
}

export class InteractiveIoHost extends NonInteractiveIoHost implements IIoHost {
  private readonly requireDeployApproval: RequireApproval;

  constructor(props?: InteractiveIoHostProps) {
    super(props);
    this.requireDeployApproval = props?.requireApproval ?? RequireApproval.BROADENING;
  }

  // NonInteractiveIoHost ã® requestResponse ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±çš„ãªã‚„ã‚Šå–ã‚ŠãŒã§ããªã„ç‚ºã€`requestResponse` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ override ã—ã¦å¯¾è©±çš„ãªã‚„ã‚Šå–ã‚Šã‚’å®Ÿè£…ã™ã‚‹
  // å®Ÿè£…ã¯ aws-cdk-cli ã® CliIoHost ã® requestResponse ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‚è€ƒã«ã—ã¦ã„ã‚‹
  // ref: https://github.com/aws/aws-cdk-cli/blob/@aws-cdk/toolkit-lib@v1.2.4/packages/aws-cdk/lib/cli/io-host/cli-io-host.ts
  override async requestResponse<DataType, ResponseType>(
    msg: IoRequest<DataType, ResponseType>
  ): Promise<ResponseType> {
    const message = msg as IoRequestMessage;
    if (this.skipApprovalStep(message)) return true as ResponseType;

    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });

    try {
      // defaultResponse ãŒ boolean ã§ãªã„å ´åˆã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã¤ã€‚ãã®å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›ç­”ã—ãŸå†…å®¹ã‚’å¤‰æ›ã—ã¦è¿”ã™
      if (typeof msg.defaultResponse !== 'boolean') {
        const prompt = this.extractPromptInfo(message);
        const desc = message.data?.responseDescription ?? prompt.default;
        const answer = await rl.question(`${message.message}${desc ? ` (${desc})` : ''}: `);
        const finalAnswer = answer.trim() || prompt.default;
        return prompt.convertAnswer(finalAnswer) as ResponseType;
      }
      // defaultResponse ãŒ boolean ã®å ´åˆã¯ã€æ‰¿èªã‚’æ±‚ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã¤
      const answer = await rl.question(`${msg.message} (y/n): `);
      const confirmed = answer.toLowerCase().trim() === 'y' || answer.toLowerCase().trim() === 'yes';
      if (!confirmed) throw new Error('Aborted by user');
      return confirmed as ResponseType;
    } finally {
      rl.close();
    }
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
   * @returns æ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹å ´åˆã¯ true
   */
  private skipApprovalStep(msg: IoRequestMessage): boolean {
    // `CDK_TOOLKIT_I5060` ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿå¯†ã®å¤‰æ›´ã‚’ç¢ºèªã™ã‚‹ã‚³ãƒ¼ãƒ‰
    // https://github.com/aws/aws-cdk-cli/blob/@aws-cdk/toolkit-lib@v1.2.4/packages/@aws-cdk/toolkit-lib/docs/message-registry.md
    const approvalToolkitCodes = ['CDK_TOOLKIT_I5060'];
    if (!approvalToolkitCodes.includes(msg.code)) return false;
    switch (this.requireDeployApproval) {
      case RequireApproval.NEVER:
        return true;
      case RequireApproval.ANYCHANGE:
        return false;
      case RequireApproval.BROADENING:
        return ['none', 'non-broadening'].includes(msg.data?.permissionChangeType ?? '');
    }
  }

  /**
   * ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹
   * @returns ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  private extractPromptInfo(request: IoRequest<unknown, unknown>): {
    default: string;
    defaultDesc: string;
    convertAnswer: (input: string) => string | number;
  } {
    const defaultResponse = util.format(request.defaultResponse);
    return {
      default: defaultResponse,
      defaultDesc: 'defaultDescription' in request && request.defaultDescription ? util.format(request.defaultDescription) : defaultResponse,
      convertAnswer: typeof request.defaultResponse === 'number' ? v => Number(v) : v => String(v),
    };
  }
}
```

::::

### ä»Šå¾Œã®æ”¹å–„äºˆå®š

ä»¥å‰ã€aws-cdk-cli ãƒªãƒã‚¸ãƒˆãƒªã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ã‚’å¿…è¦ã¨ã™ã‚‹(ã‚ã‚‹ã„ã¯å¿…è¦ã®æœ‰ç„¡ã‚’æŒ‡å®šã§ãã‚‹) InteractiveIoHost ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’ææ¡ˆã™ã‚‹ issue ãŒæŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ã“ã¡ã‚‰ã¯ not planned ã¨ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/aws/aws-cdk-cli/issues/761

ãã®ç‚ºã€ã—ã°ã‚‰ãã®é–“ã¯è‡ªå‰ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚

(ãŸã ã€ã“ã® issue ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€Toolkit Library ã® IO Host å‘¨ã‚Šã®æ©Ÿèƒ½ãŒå®‰å®šã—ã¦ããŸæ®µéšã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚’å¿…è¦ã¨ã™ã‚‹ IO Host ã®å®Ÿè£…ãŒå†åº¦æ¤œè¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)

## å‚è€ƒæ–‡çŒ®

https://go-to-k.hatenablog.com/entry/cdk-toolkit-cli-comparison
